var link_path = document.location.origin + document.location.pathname,
    templateDD = document.querySelector('.elementor-control-fp_content_template select'),
    preloadImg = tpae_createtemp_localize.L_THEPLUS_ASSETS_URL + '/images/live-editor/pre_loaderr.gif',
    headerLogo = tpae_createtemp_localize.L_THEPLUS_ASSETS_URL + '/images/tpae-favicon-white.png';


var leGlob = new Map()
var interval = setInterval(function () {
    var templateDD = document.querySelector('.elementor-control-fp_content_template select');

    // if (templateDD) {
        clearInterval(interval);
        
        jQuery(document).on('click', ".tp-live-editor", function () {
            var getprevController = this.closest('.elementor-control-type-raw_html').previousSibling;

            if( getprevController.classList.contains('tp-template-create-btn') ) {
                var getSelect = getprevController.querySelector('select'),
                    temp_title = getSelect.selectedOptions[0].text,
                    tempVal = getSelect.value;

                document.querySelector('.elementor-editor-active').insertAdjacentHTML('afterbegin',`<div class="tp-live-editor-main"><div class="tp-pre-loader"><img src="${preloadImg}"></div><div class="tp-live-editor-wrapper" style="display:none"><div class="tp-live-editor-header" style="width:80%;"><div class="tp-logo"><img src="${headerLogo}" class="tp-icon"></img><h6>The Plus Addons for Elementor</h6></div><div class="tp-title-input"><input type="text" id="tp-title-le" placeholder="Enter template name..." value="${temp_title}"><button class="tp-title-change-edit">Update Title</button></div><div class="tp_controler"><div class="tp-le-max"><i class="theplus-i-expand"></i></div><div class="tp-le-close"><i class="theplus-i-cross"></i></div></div></div><div class="tp-live-editor-iframe" style="width:80%;"><iframe src="${link_path}?post=${tempVal}&action=elementor"></iframe></div></div></div>`)

                jQuery('.tp-live-editor-iframe iframe').on('load', function () {
                    var tp_le_wrapper = document.querySelectorAll('.tp-live-editor-wrapper'),
                        pre_loader = document.querySelectorAll('.tp-pre-loader'),
                        updtButton = document.querySelector('.tp-title-change-edit');

                    if (tp_le_wrapper.length > 0) {
                        pre_loader[0].style.display = "none"
                        tp_le_wrapper[0].style.display = "flex"
                    }
                    
                    document.querySelector("#tp-title-le").addEventListener("focus", function (e) {
                        leGlob.set('titleVal', e.target.value);
                    });
                    document.querySelector("#tp-title-le").addEventListener("input", function (e) {
                        if (leGlob.get('titleVal') == e.target.value) {
                            leGlob.set('val', false)
                            updtButton.style.background = '#C4C4C4 ';
                        } else {
                            updtButton.style.background = '#676767';
                            leGlob.set('val', true)
                        }
                    });
                    updtButton.style.background = '#C4C4C4 ';

                    jQuery(document).on('click', ".tp-title-change-edit", function () {
                        var title_cur = jQuery('#tp-title-le').val();
                        
                        if(leGlob.get('val')){
                            leGlob.set('val', false)
                            jQuery.ajax({
                                type: "POST",
                                url: tpae_createtemp_localize.ajax_url,
                                dataType: "JSON",
                                data: {
                                    action: "change_current_template_title",
                                    security: tpae_createtemp_localize.nonce,
                                    updated_title: title_cur,
                                    id: tempVal,
                                },
                                success: function (res) {
                                    // console.log(res.data.post_title);
                                },
                                error: function (err) {
                                    console.log(err);
                                }
                            });
                        }else{
                            updtButton.style.background = '#C4C4C4 ';
                        }
                    })
                });
            }
        });
    // }
}, 100);

/*Create template */
jQuery(document).on('click', '.tp-live-create', function () {

    jQuery.ajax({
        type: "POST",
        url: tpae_createtemp_localize.ajax_url,
        dataType: "JSON",
        data: {
            action: "tpae_template_create",
            security: tpae_createtemp_localize.nonce,
        },
        success: function (res) {

            var link_path_live = res.data.url,
                id_live = res.data.id,
                title_live = res.data.title;
            document.querySelector('.elementor-editor-active').insertAdjacentHTML('afterbegin',`<div class="tp-live-editor-main"><div class="tp-pre-loader"><img src="${preloadImg}"></div><div class="tp-live-editor-wrapper" style="display:none"><div class="tp-live-editor-header" style="width:80%;"><div class="tp-logo"><img src="${headerLogo}" class="tp-icon"></img><h6>The Plus Addons for Elementor</h6></div><div class="tp-title-input"><input type="text" id="tp-title-le" placeholder="Enter template name..." value="${title_live}"><button class="tp-title-change" data-id="${id_live}">Update Title</button></div><div class="tp_controler"><div class="tp-le-max"><i class="theplus-i-expand"></i></div><div class="tp-le-close"><i class="theplus-i-cross"></i></div></div></div><div class="tp-live-editor-iframe" style="width:80%;"><iframe src="${link_path_live}"></iframe></div></div></div>`)

            let getDD = document.querySelector('#elementor-controls .tp-template-create-btn select');
                option = document.createElement('option');
                option.value = id_live
                option.text = title_live;
                getDD.add(option);
                getDD.value = id_live;
                jQuery(getDD).trigger("change");

            jQuery('.tp-live-editor-iframe iframe').on('load', function () {
                var tp_le_wrapper = document.querySelectorAll('.tp-live-editor-wrapper'),
                    pre_loader = document.querySelectorAll('.tp-pre-loader'),
                    updtButton = document.querySelector('.tp-title-change');
                if (tp_le_wrapper.length > 0) {
                    pre_loader[0].style.display = "none"
                    tp_le_wrapper[0].style.display = "flex"
                }
                document.querySelector("#tp-title-le").addEventListener("focus", function (e) {
                    leGlob.set('titleVal', e.target.value);
                });
                document.querySelector("#tp-title-le").addEventListener("input", function (e) {
                    if (leGlob.get('titleVal') == e.target.value) {
                        leGlob.set('val', false)
                        updtButton.style.background = '#C4C4C4 ';
                    } else {
                        updtButton.style.background = '#676767';
                        leGlob.set('val', true)
                    }
                });
                document.querySelector('.tp-title-change').style.background = '#C4C4C4 ';
                jQuery(document).on('click', '.tp-title-change', function () {
                    var title = jQuery('#tp-title-le').val(),
                        data_id = jQuery(this).data('id')
                    
                    if(leGlob.get('val')){
                        leGlob.set('val', false)
                        jQuery.ajax({
                            type: "POST",
                            url: tpae_createtemp_localize.ajax_url,
                            dataType: "JSON",
                            data: {
                                action: "change_current_template_title",
                                security: tpae_createtemp_localize.nonce,
                                updated_title: title,
                                id: data_id,
                            },
                            success: function (res) {
                                // console.log(res);
                            },
                            error: function (err) {
                                console.log(err);
                            }
                        });
                    }else{
                        updtButton.style.background = '#C4C4C4 ';
                    }
                })
            });
        },
        error: function (err) {
            console.log(err);
        }
    });

});

jQuery(document).on('click', '.tp-le-close', function () {
    let getDD = document.querySelector('#elementor-controls .tp-template-create-btn select');
    jQuery(getDD).trigger("change");
    document.querySelector('.tp-live-editor-main').remove();
})

jQuery(document).on('click', '.tp-le-max', function () {
    var tp_le_header = document.querySelector('.tp-live-editor-header'),
        tp_le_iframe = document.querySelector('.tp-live-editor-iframe')

    if (tp_le_header.style.width == "80%") {
        document.querySelector('.tp-le-max').innerHTML = '';
        document.querySelector('.tp-le-max').insertAdjacentHTML('afterbegin',`<i class="theplus-i-minimize"></i>`);
        tp_le_header.style.width = "100%";
        tp_le_iframe.style.width = "100%";
        tp_le_iframe.style.height = "100%";

    } else if (tp_le_header.style.width == "100%") {
        document.querySelector('.tp-le-max').innerHTML = '';
        document.querySelector('.tp-le-max').insertAdjacentHTML('afterbegin',`<i class="theplus-i-expand"></i>`)
        tp_le_header.style.width = "80%";
        tp_le_iframe.style.width = "80%";
        tp_le_iframe.style.height = "80%";

    }
})